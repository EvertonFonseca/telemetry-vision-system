---
title: "Untitled"
format: html
---


```{r}
library(RMariaDB)
library(DBI)
library(tidyverse)
library(magick)

# Requer: DBI, RMariaDB
# con: conexão ativa DBI::dbConnect(RMariaDB::MariaDB(), ...)
# cd_id_frame: BIGINT do frame "alvo"
# janela: quantos registros trazer (inclui o alvo)
# include_blob: se TRUE, junta tabela FRAME_CAMERA_BLOB
# ascending: se TRUE, reordena crescente ao final (útil p/ processar do mais antigo p/ o mais novo)
get_frames_window <- function(con, cd_id_frame, janela = 10L, include_blob = TRUE, ascending = TRUE) {
  stopifnot(janela >= 1L)

  # 1) Pega câmera e timestamp do frame alvo
  seed <- DBI::dbGetQuery(
    con,
    "SELECT CD_ID_CAMERA, DT_HR_LOCAL
       FROM FRAME_CAMERA
      WHERE CD_ID_FRAME = ?",
    params = list(as.numeric(cd_id_frame))
  )
  if (!nrow(seed)) stop("CD_ID_FRAME não encontrado: ", cd_id_frame)

  cam_id <- seed$CD_ID_CAMERA[1]
  dt_ref <- seed$DT_HR_LOCAL[1]

  # 2) Monta a query de janela na mesma câmera
  select_blob <- if (isTRUE(include_blob)) ", fcb.ID_FRAME_BLOB, fcb.DATA_FRAME" else ""
  join_blob   <- if (isTRUE(include_blob)) " LEFT JOIN FRAME_CAMERA_BLOB fcb ON fcb.CD_ID_FRAME = fc.CD_ID_FRAME " else ""

  sql <- paste0(
    "SELECT fc.CD_ID_FRAME, fc.DT_HR_LOCAL, fc.CD_ID_CAMERA",
    select_blob, "
       FROM FRAME_CAMERA fc",
    join_blob, "
      WHERE fc.CD_ID_CAMERA = ?
        AND fc.DT_HR_LOCAL <= ?
      ORDER BY fc.DT_HR_LOCAL DESC, fc.CD_ID_FRAME DESC
      LIMIT ?"
  )

  df <- DBI::dbGetQuery(
    con, sql,
    params = list(as.numeric(cam_id), as.character(dt_ref), as.integer(janela))
  )

  # 3) Opcional: reordenar crescente para processamento temporal
  if (isTRUE(ascending) && nrow(df)) {
    df <- df[order(df$DT_HR_LOCAL, df$CD_ID_FRAME), , drop = FALSE]
  }
  df
}

get_frames_from_to <- function(con,
                               from_time,
                               to_time,
                               camera_ids  = NULL,   # NULL, escalar ou vetor de IDs
                               include_blob = TRUE,
                               ascending    = TRUE) {

  stopifnot(!is.null(from_time), !is.null(to_time))

  # Partes dinâmicas
  select_blob <- if (isTRUE(include_blob))
    ", fcb.ID_FRAME_BLOB, fcb.DATA_FRAME" else ""
  join_blob <- if (isTRUE(include_blob))
    " LEFT JOIN FRAME_CAMERA_BLOB fcb ON fcb.CD_ID_FRAME = fc.CD_ID_FRAME " else ""

  order_dir <- if (isTRUE(ascending)) "ASC" else "DESC"

  # WHERE base (BETWEEN inclusivo)
  sql <- paste0(
    "SELECT fc.CD_ID_FRAME, fc.DT_HR_LOCAL, fc.CD_ID_CAMERA", select_blob, "
       FROM FRAME_CAMERA fc", join_blob, "
      WHERE fc.DT_HR_LOCAL BETWEEN ? AND ?"
  )
  params <- list(as.character(from_time), as.character(to_time))

  # Filtro opcional por UMA OU MAIS câmeras
  if (!is.null(camera_ids)) {
    cams <- unique(na.omit(as.numeric(camera_ids)))
    if (length(cams) == 1L) {
      sql <- paste0(sql, " AND fc.CD_ID_CAMERA = ?")
      params <- c(params, cams)
    } else if (length(cams) > 1L) {
      placeholders <- paste(rep("?", length(cams)), collapse = ",")
      sql <- paste0(sql, " AND fc.CD_ID_CAMERA IN (", placeholders, ")")
      params <- c(params, as.list(cams))
    } # se length 0 após na.omit, ignora
  }

  # Ordenação estável
  sql <- paste0(sql, " ORDER BY fc.DT_HR_LOCAL ", order_dir, ", fc.CD_ID_FRAME ", order_dir)

  # Execução
  df <- DBI::dbGetQuery(con, sql, params = params)

  # (Opcional) reforçar crescente para processamento temporal
  if (isTRUE(ascending) && nrow(df)) {
    df <- df[order(df$DT_HR_LOCAL, df$CD_ID_FRAME), , drop = FALSE]
  }

  df
}

build_gif_from_blob <- function(frames, fps = 5L, out_gif = "frames.gif",
                                annotate_ts = FALSE, pause_sec = 1.5, write_file = TRUE) {

  stopifnot(nrow(frames) > 0)

  imgs <- lapply(seq_len(nrow(frames)), function(i) {
    img <- magick::image_read(frames$DATA_FRAME[[i]])
    if (isTRUE(annotate_ts)) {
      ts <- format(frames$DT_HR_LOCAL[i], "%Y-%m-%d %H:%M:%OS3")
      img <- magick::image_annotate(
        img, ts, gravity = "SouthEast", size = 16,
        color = "white", boxcolor = "rgba(0,0,0,0.45)"
      )
    }
    img
  })

  # Segurar o último frame por 'pause_sec' segundos:
  if (pause_sec > 0) {
    hold_n <- max(1L, round(pause_sec * fps))
    lastf  <- imgs[[length(imgs)]]
    imgs   <- c(imgs, rep(list(lastf), hold_n))
  }

  # join -> animate (loop=1: toca uma vez e para)
  anim <- magick::image_animate(
    magick::image_join(imgs),
    fps = fps,
    dispose = "previous",
    loop = 1
  )

  if (isTRUE(write_file)) {
    magick::image_write(anim, path = out_gif, format = "gif")
    message("GIF gerado: ", normalizePath(out_gif, winslash = "/"))
  }
  anim
}

selectAllContext <- function(con){

    sql <- paste0("SELECT 
                    oc.DATA_OC as ATRIBUTOS,
                    oc.DT_HR_LOCAL as DATE_TIME,
                    o.NAME_OBJETO, OBJETO,
                    s.NAME_SETOR, SETOR,
                    oc.CD_ID_FRAME
                    FROM objeto_contexto oc
                    LEFT JOIN objeto o ON o.CD_ID_OBJETO = oc.CD_ID_OBJETO
                    LEFT JOIN setor s ON s.CD_ID_SETOR = o.CD_ID_SETOR
                    #WHERE name_objeto = 'SETREMA'
                    ORDER BY DT_HR_LOCAL DESC")
    DBI::dbGetQuery(con,sql)
}


```

# Open connection


```{r}
con <- DBI::dbConnect(
            RMariaDB::MariaDB(),
            dbname = 'system',
            username = 'root',
            password = 'ssbwarcq',
            host = '127.0.0.1',
            port = 3306
        )


# con <- DBI::dbConnect(
#             RMariaDB::MariaDB(),
#             dbname = 'system',
#             username = 'root',
#             password = 'elite@',
#             host = '172.30.0.26',
#             port = 3306
#         )

```

## Frames

```{r}

frames <- get_frames_window(con,1001418,janela = 35)
#frames$DATE_TIME <- format(frames$DT_HR_LOCAL,"%d/%m/%y %H:%M:%S:%OS3")
difftime(last(frames$DT_HR_LOCAL),first(frames$DT_HR_LOCAL))

```

# Video

```{r}
codigo  <-1597980
anime   <- build_gif_from_blob( get_frames_window(con,codigo,janela = 35))
print(anime)

```


```{r}
# | eval: false
df <- dbGetQuery(con,"SELECT 
 oc.DATA_OC AS ATRIBUTOS,
 oc.DT_HR_LOCAL AS DATE_TIME,
 o.NAME_OBJETO AS OBJETO,
 s.NAME_SETOR AS SETOR
 FROM objeto_contexto oc
 LEFT JOIN objeto o ON o.CD_ID_OBJETO = oc.CD_ID_OBJETO
 LEFT JOIN setor s ON s.CD_ID_SETOR = o.CD_ID_SETOR
 ORDER BY DT_HR_LOCAL ASC")

df$DATA_OC <- str_replace_all(df$ATRIBUTOS,"SODA","SOLDA")
write.csv(df,"telemetria.csv")
```

# Validas os pacotes IA

```{r}

pacotes <- dbGetQuery(con,"select * from pacote_ia")
pacotes <- pacotes |> filter(CD_ID_OBJETO == 1L)
index   <- 5
from    <- pacotes$DT_HR_LOCAL_BEGIN[index]
to      <- pacotes$DT_HR_LOCAL_END[index]

print(pacotes$OUTPUT_IA[index])

frames <- get_frames_from_to(con,from_time = from,to_time = to,camera_id = c(2))
build_gif_from_blob(frames)

#oks
# 1,2,3,5
```