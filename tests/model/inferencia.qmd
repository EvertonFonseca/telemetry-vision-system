---
title: "Untitled"
format: html
---


```{r}
library(RMariaDB)
library(DBI)
library(tidyverse)
library(magick)

# Requer: DBI, RPostgres
# con: conexão ativa DBI::dbConnect(RPostgres::Postgres(), ...)

# ------------------------------------------------------------
# 1) Janela de frames: pega (cam_id, dt_ref) do frame alvo e busca
#    os "janela" frames mais recentes <= dt_ref na mesma câmera.
#    ✅ Postgres: placeholders $1, $2, $3...
# ------------------------------------------------------------
get_frames_window <- function(con,
                              cd_id_frame,
                              janela = 10L,
                              include_blob = TRUE,
                              ascending = TRUE) {
  stopifnot(janela >= 1L)

  # 1) Pega câmera e timestamp do frame alvo
  seed <- DBI::dbGetQuery(
    con,
    "
    SELECT cd_id_camera, dt_hr_local
      FROM frame_camera
     WHERE cd_id_frame = $1
    ",
    params = list(as.numeric(cd_id_frame))
  )

  if (!nrow(seed)) stop("cd_id_frame não encontrado: ", cd_id_frame)

  cam_id <- seed$cd_id_camera[1]
  dt_ref <- seed$dt_hr_local[1]

  # 2) Monta query de janela (mesma câmera, <= dt_ref)
  select_blob <- if (isTRUE(include_blob)) ", fcb.id_frame_blob, fcb.data_frame" else ""
  join_blob   <- if (isTRUE(include_blob)) " LEFT JOIN frame_camera_blob fcb ON fcb.cd_id_frame = fc.cd_id_frame " else ""

  sql <- paste0(
    "SELECT fc.cd_id_frame, fc.dt_hr_local, fc.cd_id_camera",
    select_blob, "
       FROM frame_camera fc",
    join_blob, "
      WHERE fc.cd_id_camera = $1
        AND fc.dt_hr_local <= $2
      ORDER BY fc.dt_hr_local DESC, fc.cd_id_frame DESC
      LIMIT $3"
  )

  df <- DBI::dbGetQuery(
    con, sql,
    params = list(as.numeric(cam_id), dt_ref, as.integer(janela))
  )

  # 3) Opcional: reordenar crescente para processamento temporal
  if (isTRUE(ascending) && nrow(df)) {
    df <- df[order(df$dt_hr_local, df$cd_id_frame), , drop = FALSE]
  }

  df
}

# ------------------------------------------------------------
# 2) Frames entre datas, com filtro opcional por 1..N câmeras
#    ✅ Postgres: $1..$n, IN ($3,$4,...)
# ------------------------------------------------------------
get_frames_from_to <- function(con,
                               from_time,
                               to_time,
                               camera_ids  = NULL,   # NULL, escalar ou vetor de IDs
                               include_blob = TRUE,
                               ascending    = TRUE) {

  stopifnot(!is.null(from_time), !is.null(to_time))

  select_blob <- if (isTRUE(include_blob)) ", fcb.id_frame_blob, fcb.data_frame" else ""
  join_blob   <- if (isTRUE(include_blob)) " LEFT JOIN frame_camera_blob fcb ON fcb.cd_id_frame = fc.cd_id_frame " else ""

  order_dir <- if (isTRUE(ascending)) "ASC" else "DESC"

  sql <- paste0(
    "SELECT fc.cd_id_frame, fc.dt_hr_local, fc.cd_id_camera", select_blob, "
       FROM frame_camera fc", join_blob, "
      WHERE fc.dt_hr_local BETWEEN $1 AND $2"
  )
  params <- list(from_time, to_time)

  # Filtro opcional por 1..N câmeras
  if (!is.null(camera_ids)) {
    cams <- unique(na.omit(as.numeric(camera_ids)))
    if (length(cams) == 1L) {
      sql <- paste0(sql, " AND fc.cd_id_camera = $3")
      params <- c(params, list(cams[1]))
    } else if (length(cams) > 1L) {
      # placeholders $3..$(2+N)
      ph <- paste0("$", seq.int(3L, 2L + length(cams)), collapse = ",")
      sql <- paste0(sql, " AND fc.cd_id_camera IN (", ph, ")")
      params <- c(params, as.list(cams))
    }
  }

  sql <- paste0(sql, " ORDER BY fc.dt_hr_local ", order_dir, ", fc.cd_id_frame ", order_dir)

  df <- DBI::dbGetQuery(con, sql, params = params)

  if (isTRUE(ascending) && nrow(df)) {
    df <- df[order(df$dt_hr_local, df$cd_id_frame), , drop = FALSE]
  }

  df
}

# ------------------------------------------------------------
# 3) GIF a partir de blob (sem alteração específica de banco)
# ------------------------------------------------------------
build_gif_from_blob <- function(frames, fps = 5L, out_gif = "frames.gif",
                                annotate_ts = FALSE, pause_sec = 1.5, write_file = TRUE) {
  stopifnot(nrow(frames) > 0)

  imgs <- lapply(seq_len(nrow(frames)), function(i) {
    img <- magick::image_read(frames$data_frame[[i]])
    if (isTRUE(annotate_ts)) {
      ts <- format(frames$dt_hr_local[i], "%Y-%m-%d %H:%M:%OS3")
      img <- magick::image_annotate(
        img, ts, gravity = "SouthEast", size = 16,
        color = "white", boxcolor = "rgba(0,0,0,0.45)"
      )
    }
    img
  })

  if (pause_sec > 0) {
    hold_n <- max(1L, round(pause_sec * fps))
    lastf  <- imgs[[length(imgs)]]
    imgs   <- c(imgs, rep(list(lastf), hold_n))
  }

  anim <- magick::image_animate(
    magick::image_join(imgs),
    fps = fps,
    dispose = "previous",
    loop = 1
  )

  if (isTRUE(write_file)) {
    magick::image_write(anim, path = out_gif, format = "gif")
    message("GIF gerado: ", normalizePath(out_gif, winslash = "/"))
  }

  anim
}

# ------------------------------------------------------------
# 4) Contexto (objeto_contexto + objeto + setor)
#    ✅ Postgres: comentário "--" (não "#")
#    ✅ corrige SELECT/aliases (antes tinha "o.NAME_OBJETO, OBJETO" quebrado)
# ------------------------------------------------------------
selectAllContext <- function(con) {
  sql <- "
    SELECT
      oc.data_oc   AS atributos,
      oc.dt_hr_local AS date_time,
      o.name_objeto  AS objeto,
      s.name_setor   AS setor,
      oc.cd_id_frame AS cd_id_frame
    FROM objeto_contexto oc
    LEFT JOIN objeto o ON o.cd_id_objeto = oc.cd_id_objeto
    LEFT JOIN setor  s ON s.cd_id_setor  = o.cd_id_setor
    -- WHERE o.name_objeto = 'SETREMA'
    ORDER BY oc.dt_hr_local DESC
  "
  DBI::dbGetQuery(con, sql)
}


```

# Open connection


```{r}
con <- DBI::dbConnect(
  drv = RPostgres::Postgres(),
  dbname = "analytia_db",
  host = "172.30.0.14",
  port = 5434,
  user = "analytia",
  password = "analytia",
)
```

## Frames

```{r}
# | eval: false
frames <- get_frames_window(con,16159573,janela = 35)
#frames$DATE_TIME <- format(frames$DT_HR_LOCAL,"%d/%m/%y %H:%M:%S:%OS3")
difftime(last(frames$DT_HR_LOCAL),first(frames$DT_HR_LOCAL))

x <- DBI::dbGetQuery(con,"select * from objeto_contexto ORDER BY dt_hr_local desc")
x$dt_hr_local <- as.POSIXct(x$dt_hr_local,Sys.timezone())

x <- x |> filter(dt_hr_local <= as.POSIXct("2026-01-30 14:02:40 -03"))
x <- x |> filter(cd_id_objeto == 1)

max(x$dt_hr_local)
x <- first(x)
```

# Video

```{r}
x$cd_id_frame
codigo  <- 236252

anime   <- build_gif_from_blob(get_frames_window(con,codigo,janela = 35))
print(anime)

x$data_oc
```

```{r}
# | eval: false
df <- dbGetQuery(con,"SELECT 
 oc.DATA_OC AS ATRIBUTOS,
 oc.DT_HR_LOCAL AS DATE_TIME,
 o.NAME_OBJETO AS OBJETO,
 s.NAME_SETOR AS SETOR
 FROM objeto_contexto oc
 LEFT JOIN objeto o ON o.CD_ID_OBJETO = oc.CD_ID_OBJETO
 LEFT JOIN setor s ON s.CD_ID_SETOR = o.CD_ID_SETOR
 ORDER BY DT_HR_LOCAL ASC")

df$DATA_OC <- str_replace_all(df$ATRIBUTOS,"SODA","SOLDA")
write.csv(df,"telemetria.csv")
```

# Validas os pacotes IA

```{r}

pacotes <- dbGetQuery(con,"select * from pacote_ia")
pacotes <- pacotes |> filter(CD_ID_OBJETO == 1L)
index   <- 5
from    <- pacotes$DT_HR_LOCAL_BEGIN[index]
to      <- pacotes$DT_HR_LOCAL_END[index]

print(pacotes$OUTPUT_IA[index])

frames <- get_frames_from_to(con,from_time = from,to_time = to,camera_id = c(2))
build_gif_from_blob(frames)

#oks
# 1,2,3,5

dados <- dbGetQuery(con,"SELECT 
        oc.DATA_OC     AS ATRIBUTOS,
        oc.DT_HR_LOCAL AS DATE_TIME,
        o.NAME_OBJETO  AS OBJETO,
        s.NAME_SETOR   AS setor,
        VISIBLE
     FROM objeto_contexto oc
     LEFT JOIN objeto o       ON o.CD_ID_OBJETO = oc.CD_ID_OBJETO
     LEFT JOIN setor s        ON s.CD_ID_SETOR  = o.CD_ID_SETOR
     WHERE o.FG_ATIVO = 1 AND VISIBLE >= 90 ORDER BY DT_HR_LOCAL DESC")

write.csv(dados,"dados.csv")
```
